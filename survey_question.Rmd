---
title: "De-list endangered salmon and steelhead of the Lower Columbia River Basin"
subtitle: "Effectiveness of guided site visits"
author: "Minnie"
output: beamer_presentation
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load, echo=FALSE}
# Load the required packages
library(DeclareDesign)
library(knitr)
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(kableExtra)
```

## Measurement Goal & Measure

**Goal**: Test effectiveness of guided site visits in increasing program awareness and making good impressions on visitors.

" Please rate your experience today [with X guide] on the following (Likert) scale:"

a. Very Satisfied
b. Somewhat Satisfied
c. Neutral
d. Somewhat Dissatisfied
e. Very Dissatisfied

*Note: present in horizontal line to prevent order bias

## Source & Rationale & Unit

*Source*: Each visitor will be asked to complete the survey following the guided site visit.

*Rationale*: The site visits are provided in order to provide potential donors and collaborators with first-hand experience of the program elements and impacts. The assumption we are testing is whether site visits truly increase visitor knowledge and leave guests with a positive impression. This measure of visit satisfaction will later be correlated with actual future engagement.

*Unit*: Individual survey respondent


## Responsibility & Frequency

*Responsibility*: The survey should be administered by a staff member (possibly administrator) other than the tour guide, or via email. The survey should be partially anonymous - guests should not feel uncomfortable providing honest feedback, but it will be helpful to include some identifying information that will allow other measures (which organization they represent and the $ amount of the donation or hours of work on a collaboration) to be correlated with tour satisfaction.

*Frequency*: Every individual should be asked to take the survey, since each could represent a different donor organization. Additionally, if there are multiple tour guides, it would be important to determine which/whose strategy is most effective. 


## Declaring the population

Administrative data shows that 20 tours are led throughout the year, with 10 individuals are on each tour, for a total of 200 visitors.

Organizations       Visitors               Surveys Completed
-----------        ------------------      ------------------
Will Donate              150                      100%
Will Not Donate          50                       50%


## Target Population & Challenges

*Target Population*: All visitors who go on a site tour

*Challenge of drawing a representative sample*: Some individuals may refuse to complete the survey, and this could be correlated with their level of (dis)satisfaction with the visit - this would bias the survey towards positive feedback (sampling bias).

*Sampling procedure*: Request every visitor complete the survey at the end of their site visit.

## DeclareDesign()

```{r population}
set.seed(228)

#Minnie: Create a population of 200 visitors, of which 75% will end up donating. Then use whether or not visitors are donors to determine their level of satisfaction. This means that visitors' donor status is directly correlated to whether or not they were satisfied with the tour (the assumption we are testing).

population <- declare_population(
  visitors = add_level(N=200,
                       donor = sample(c(rep(0,50),rep(1,150))),
     satisfied=correlate(given = donor, rho = 0.8,
                         draw_binary, prob = 0.5)
))

#Minnie: To make satisfaction a binary condition, a response of "neutral" or more negative is considered "dissatisfied" and both "satisfied" and "very satisfied" are considered "satisfied".
#Minnie:rho = 0.8 --> donor status highly correlated with being satisfied

pop <- population()

kable(table(pop$donor,pop$satisfied)) %>% 
  add_header_above(c("donor"=1,"satisfied"=2))

my_estimand <- declare_estimands(mean(pop$satisfied),
                                 label = "Ybar")
#Minnie: Estimand is the mean level of knowledge among the sample.
```

## Declaring response bias

```{r reporting, echo=FALSE}

reporting <- declare_assignment(blocks=donor,
                  assignment_variable = "A", 
                  block_prob=c(0.5,1.0))

#Minnie: Donors will all complete the survey, half of non-donors will refuse to complete it --> donors are more likely to  be "reporters"

#Minnie: no stratification in this example?

pop <- reporting(pop)
table(pop$donor,pop$A)

sampling <- declare_sampling(n=10)

```

```{r sampling}

sims <- 1000 #simulations
sample_n <- 10 #attempted sample size
store <- rep(NA, sims)

for (i in 1:sims){
  index <- sample(1:200,sample_n) #drawn sample
  pop <- reporting(pop)
  donate <- mean(pop[index,] %>%
               filter(A==1 & donor==1) %>%
               pull(satisfied))
  nodonate <- mean(pop[index,] %>%
               filter(A==1 & donor==0) %>%
               pull(satisfied))
  store[i] <- donate * 0.5 + nodonate * 0.5
}

summary(store)
prop.se.store <- sd(store, na.rm = TRUE)

```


## DeclareDesign()

```{r diagnosis, cache=TRUE}

donor_mean <- function(data){
  data.frame(  
  estimator_label = "mean",
  estimand_label = "Ybar",
  n = nrow(data),
  stringsAsFactors = FALSE,
  
  estimate = data %>% filter(A==1) %>% #PH: subset out units that are not sampled.
   # group_by(port) %>% 
    summarise(mean=mean(donor, na.rm = TRUE))) #%>%
  #  mutate(prop=pop.vector/sum(pop.vector)) %>% #PH: 'prop' is a variable calculating the proportion of units in the population that are at a given port.
  #  mutate(sub.mean=mean*prop) %>% pull(sub.mean) %>%  #PH: 'sub.mean' is a weighted average of the knowledge level within a given port.
  #  sum()) #PH: sums all the weighed averages of knowledge within ports to get a weighted sample mean.
} #just use this function, custom

#PH: here, we're declaring a second estimator that will estimate the population mean by calculating a strata weighted mean of the sample

answer <- declare_estimator(
 handler = tidy_estimator(donor_mean), #PH: this is the custom function we wrote in the chunk above.
  estimand = my_estimand) #PH: 'my_estimand' is the true population mean of knowledge. We happen to know this in this case (b/c we faked the data), but you'll have to make an educated guess about what this is in practice. Often, you see people designing M&E programs cite research to take a stab at the actual value of the estimand.

design <- population + reporting + sampling + my_estimand + answer
diagnosis <- diagnose_design(design, sims = 1000)

diagnosis$diagnosands_df[,c(4,5,12,14)] %>%
  kable()

```



